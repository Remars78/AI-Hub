<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body { margin: 0; padding: 16px; background: #121212; color: white; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        h2 { margin: 0 0 10px 0; text-align: center; }
        #canvas-container { flex: 1; background: white; border-radius: 12px; overflow: hidden; position: relative; touch-action: none; margin-bottom: 10px; }
        canvas { display: block; width: 100%; height: 100%; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; background: #222; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 8px; }
        #btn-gen { background: #6200EE; color: white; }
        #btn-clear { background: #CF6679; color: black; }
        #status { text-align: center; margin-top: 5px; color: #aaa; font-size: 14px; }
        #result-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 10; }
        #result-img { max-width: 90%; max-height: 70%; border-radius: 8px; border: 2px solid white; }
        #close-res { margin-top: 20px; background: white; color: black; width: auto; padding: 10px 30px; }
    </style>
</head>
<body>

    <h2>Sketch to AI</h2>
    
    <div id="canvas-container">
        <canvas id="sketchCanvas"></canvas>
    </div>

    <input type="text" id="promptInput" placeholder="Describe your sketch..." />
    <button id="btn-gen">Generate with Gemini 2.5</button>
    <button id="btn-clear">Clear Canvas</button>
    <div id="status">Draw something & enter prompt</div>

    <div id="result-overlay">
        <img id="result-img" />
        <button id="close-res">Close</button>
    </div>

<script>
    const canvas = document.getElementById('sketchCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    
    // Настройка размера канваса
    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'black';
    }
    window.onload = resize;

    // Рисование
    let drawing = false;

    function startDraw(e) {
        drawing = true;
        draw(e);
    }
    function endDraw() {
        drawing = false;
        ctx.beginPath();
    }
    function draw(e) {
        if (!drawing) return;
        e.preventDefault(); // Чтобы не скроллило страницу
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        ctx.lineTo(clientX - rect.left, clientY - rect.top);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(clientX - rect.left, clientY - rect.top);
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mousemove', draw);
    
    canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('touchend', endDraw);
    canvas.addEventListener('touchmove', draw, {passive: false});

    // Очистка
    document.getElementById('btn-clear').addEventListener('click', resize);

    // Закрытие результата
    document.getElementById('close-res').addEventListener('click', () => {
        document.getElementById('result-overlay').style.display = 'none';
    });

    // --- ГЕНЕРАЦИЯ ЧЕРЕЗ PUTER.JS ---
    document.getElementById('btn-gen').addEventListener('click', async () => {
        const prompt = document.getElementById('promptInput').value;
        const status = document.getElementById('status');
        
        if (!prompt) {
            status.innerText = "Please enter a prompt!";
            status.style.color = "red";
            return;
        }

        status.innerText = "Sending to Gemini 2.5 via Puter...";
        status.style.color = "#4CAF50";

        try {
            // Берем картинку из канваса в Base64
            const base64Url = canvas.toDataURL("image/png");
            
            // Вызов Puter.js
            const response = await puter.ai.txt2img(prompt, {
                model: "gemini-2.5-flash-image-preview", 
                image: base64Url // Puter умный, съест DataURL
            });

            // Показываем результат
            const resultImg = document.getElementById('result-img');
            resultImg.src = response.src;
            document.getElementById('result-overlay').style.display = 'flex';
            status.innerText = "Done!";

        } catch (err) {
            console.error(err);
            status.innerText = "Error: " + err.message;
            status.style.color = "red";
        }
    });
</script>
</body>
</html>
